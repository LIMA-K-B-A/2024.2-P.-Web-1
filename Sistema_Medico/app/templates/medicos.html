{% extends "base.html" %}

{% block content %}
<div class="content-card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2 style="margin: 0;">Lista de Médicos</h2>
    <button class="btn btn-primary" onclick="openAddModal()">
      <i class="fas fa-plus"></i>
      Adicionar Médico
    </button>
  </div>

  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>CRM</th>
          <th>Especialidade</th>
          <th>Email</th>
          <th>Horário de Atendimento</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="medicos-list">
        <!-- Lista de médicos será inserida aqui via JavaScript -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de Adicionar/Editar Médico -->
<div id="medicoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
  <div style="background: white; max-width: 500px; margin: 2rem auto; padding: 2rem; border-radius: 12px; box-shadow: var(--shadow-md);">
    <h2 id="modalTitle">Adicionar Médico</h2>
    <form id="medicoForm" onsubmit="handleSubmit(event)">
      <div style="margin-bottom: 1rem;">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="crm">CRM</label>
        <input type="text" id="crm" name="crm" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="especialidade">Especialidade</label>
        <input type="text" id="especialidade" name="especialidade" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="horario_atendimento">Horário de Atendimento</label>
        <input type="text" id="horario_atendimento" name="horario_atendimento" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;" placeholder="Ex: 08:00 - 18:00">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="senha">Senha</label>
        <input type="password" id="senha" name="senha" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>

      <div style="display: flex; justify-content: flex-end; gap: 1rem;">
        <button type="button" class="btn" onclick="closeModal()" style="background: var(--border-color);">Cancelar</button>
        <button type="submit" class="btn btn-primary">Salvar</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Função para carregar a lista de médicos
  async function loadMedicos() {
    try {
      const response = await fetch('/medicos');
      if (!response.ok) {
        throw new Error('Erro ao carregar médicos');
      }
      const medicos = await response.json();
      
      const tbody = document.getElementById('medicos-list');
      tbody.innerHTML = '';
      
      medicos.forEach(medico => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${medico.nome}</td>
          <td>${medico.crm}</td>
          <td>${medico.especialidade}</td>
          <td>${medico.email}</td>
          <td>${medico.horario_atendimento}</td>
          <td>
            <button class="btn" onclick="editMedico(${medico.id})" style="background: var(--primary-color-light); color: var(--primary-color); margin-right: 0.5rem;">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn" onclick="deleteMedico(${medico.id})" style="background: var(--error-color); color: white;">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error('Erro ao carregar médicos:', error);
      alert('Erro ao carregar lista de médicos: ' + error.message);
    }
  }

  // Função para abrir o modal de adicionar médico
  function openAddModal() {
    document.getElementById('modalTitle').textContent = 'Adicionar Médico';
    document.getElementById('medicoForm').reset();
    document.getElementById('medicoModal').style.display = 'block';
  }

  // Função para fechar o modal
  function closeModal() {
    document.getElementById('medicoModal').style.display = 'none';
  }

  // Função para lidar com o envio do formulário
  async function handleSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
      nome: formData.get('nome'),
      email: formData.get('email'),
      senha: formData.get('senha'),
      crm: formData.get('crm'),
      especialidade: formData.get('especialidade'),
      horario_atendimento: formData.get('horario_atendimento')
    };
    
    try {
      const response = await fetch('/medicos', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Erro ao adicionar médico');
      }
      
      closeModal();
      loadMedicos();
    } catch (error) {
      console.error('Erro:', error);
      alert(error.message);
    }
  }

  // Função para editar um médico
  async function editMedico(id) {
    try {
      const response = await fetch(`/medicos/${id}`);
      const medico = await response.json();
      
      document.getElementById('modalTitle').textContent = 'Editar Médico';
      document.getElementById('nome').value = medico.nome;
      document.getElementById('email').value = medico.email;
      document.getElementById('crm').value = medico.crm;
      document.getElementById('especialidade').value = medico.especialidade;
      document.getElementById('horario_atendimento').value = medico.horario_atendimento;
      
      document.getElementById('medicoModal').style.display = 'block';
    } catch (error) {
      console.error('Erro ao carregar médico:', error);
      alert('Erro ao carregar dados do médico');
    }
  }

  // Função para deletar um médico
  async function deleteMedico(id) {
    if (!confirm('Tem certeza que deseja excluir este médico?')) {
      return;
    }
    
    try {
      const response = await fetch(`/medicos/${id}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        throw new Error('Erro ao excluir médico');
      }
      
      loadMedicos();
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro ao excluir médico');
    }
  }

  // Carrega a lista de médicos quando a página carregar
  document.addEventListener('DOMContentLoaded', loadMedicos);
</script>
{% endblock %}