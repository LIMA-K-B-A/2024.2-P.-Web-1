{% extends "base.html" %}

{% block content %}
<div class="content-card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2 style="margin: 0;">Lista de Consultas</h2>
    <button class="btn btn-primary" onclick="openAddModal()">
      <i class="fas fa-plus"></i>
      Agendar Consulta
    </button>
  </div>

  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>Paciente</th>
          <th>Médico</th>
          <th>Data</th>
          <th>Horário</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="consultas-list">
        <!-- Lista de consultas será inserida aqui via JavaScript -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de Adicionar/Editar Consulta -->
<div id="consultaModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
  <div style="background: white; max-width: 500px; margin: 2rem auto; padding: 2rem; border-radius: 12px; box-shadow: var(--shadow-md);">
    <h2 id="modalTitle">Agendar Consulta</h2>
    <form id="consultaForm" onsubmit="handleSubmit(event)">
      <div style="margin-bottom: 1rem;">
        <label for="paciente_id">Paciente</label>
        <select id="paciente_id" name="paciente_id" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
          <option value="">Selecione um paciente</option>
        </select>
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="medico_id">Médico</label>
        <select id="medico_id" name="medico_id" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
          <option value="">Selecione um médico</option>
        </select>
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="data">Data</label>
        <input type="date" id="data" name="data" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="horario">Horário</label>
        <input type="time" id="horario" name="horario" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="status">Status</label>
        <select id="status" name="status" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
          <option value="agendada">Agendada</option>
          <option value="confirmada">Confirmada</option>
          <option value="cancelada">Cancelada</option>
          <option value="realizada">Realizada</option>
        </select>
      </div>

      <div style="display: flex; justify-content: flex-end; gap: 1rem;">
        <button type="button" class="btn" onclick="closeModal()" style="background: var(--border-color);">Cancelar</button>
        <button type="submit" class="btn btn-primary">Salvar</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Função para carregar a lista de consultas
  async function loadConsultas() {
    try {
      const response = await fetch('/consultas');
      const consultas = await response.json();
      
      const tbody = document.getElementById('consultas-list');
      tbody.innerHTML = '';
      
      consultas.forEach(consulta => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${consulta.paciente.usuario.nome}</td>
          <td>${consulta.medico.usuario.nome}</td>
          <td>${new Date(consulta.data).toLocaleDateString()}</td>
          <td>${consulta.horario}</td>
          <td>
            <span class="status-badge" style="
              padding: 0.25rem 0.5rem;
              border-radius: 4px;
              font-size: 0.875rem;
              background-color: ${getStatusColor(consulta.status)};
              color: white;
            ">
              ${consulta.status.charAt(0).toUpperCase() + consulta.status.slice(1)}
            </span>
          </td>
          <td>
            <button class="btn" onclick="editConsulta(${consulta.id})" style="background: var(--primary-color-light); color: var(--primary-color); margin-right: 0.5rem;">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn" onclick="deleteConsulta(${consulta.id})" style="background: var(--error-color); color: white;">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error('Erro ao carregar consultas:', error);
    }
  }

  // Função para carregar médicos e pacientes nos selects
  async function loadSelectOptions() {
    try {
      // Carrega médicos
      const medicosResponse = await fetch('/medicos');
      const medicos = await medicosResponse.json();
      const medicoSelect = document.getElementById('medico_id');
      medicos.forEach(medico => {
        const option = document.createElement('option');
        option.value = medico.id;
        option.textContent = `${medico.usuario.nome} - ${medico.especialidade}`;
        medicoSelect.appendChild(option);
      });

      // Carrega pacientes
      const pacientesResponse = await fetch('/pacientes');
      const pacientes = await pacientesResponse.json();
      const pacienteSelect = document.getElementById('paciente_id');
      pacientes.forEach(paciente => {
        const option = document.createElement('option');
        option.value = paciente.id;
        option.textContent = paciente.usuario.nome;
        pacienteSelect.appendChild(option);
      });
    } catch (error) {
      console.error('Erro ao carregar opções:', error);
    }
  }

  // Função para obter a cor do status
  function getStatusColor(status) {
    const colors = {
      'agendada': '#F39C12',
      'confirmada': '#3498DB',
      'cancelada': '#E74C3C',
      'realizada': '#2ECC71'
    };
    return colors[status] || '#95A5A6';
  }

  // Função para abrir o modal de adicionar consulta
  function openAddModal() {
    document.getElementById('modalTitle').textContent = 'Agendar Consulta';
    document.getElementById('consultaForm').reset();
    document.getElementById('consultaModal').style.display = 'block';
  }

  // Função para fechar o modal
  function closeModal() {
    document.getElementById('consultaModal').style.display = 'none';
  }

  // Função para lidar com o envio do formulário
  async function handleSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
      paciente_id: parseInt(formData.get('paciente_id')),
      medico_id: parseInt(formData.get('medico_id')),
      data: formData.get('data'),
      horario: formData.get('horario'),
      status: formData.get('status')
    };
    
    try {
      const response = await fetch('/consultas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Erro ao agendar consulta');
      }
      
      closeModal();
      loadConsultas();
    } catch (error) {
      console.error('Erro:', error);
      alert(error.message);
    }
  }

  // Função para editar uma consulta
  async function editConsulta(id) {
    try {
      const response = await fetch(`/consultas/${id}`);
      const consulta = await response.json();
      
      document.getElementById('modalTitle').textContent = 'Editar Consulta';
      document.getElementById('paciente_id').value = consulta.paciente_id;
      document.getElementById('medico_id').value = consulta.medico_id;
      document.getElementById('data').value = consulta.data;
      document.getElementById('horario').value = consulta.horario;
      document.getElementById('status').value = consulta.status;
      
      document.getElementById('consultaModal').style.display = 'block';
    } catch (error) {
      console.error('Erro ao carregar consulta:', error);
      alert('Erro ao carregar dados da consulta');
    }
  }

  // Função para deletar uma consulta
  async function deleteConsulta(id) {
    if (!confirm('Tem certeza que deseja excluir esta consulta?')) {
      return;
    }
    
    try {
      const response = await fetch(`/consultas/${id}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        throw new Error('Erro ao excluir consulta');
      }
      
      loadConsultas();
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro ao excluir consulta');
    }
  }

  // Carrega os dados quando a página carregar
  document.addEventListener('DOMContentLoaded', () => {
    loadConsultas();
    loadSelectOptions();
  });
</script>
{% endblock %}