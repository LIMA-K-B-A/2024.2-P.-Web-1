{% extends "base.html" %}

{% block content %}
<div class="content-card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2 style="margin: 0;">Lista de Pacientes</h2>
    <button class="btn btn-primary" onclick="openAddModal()">
      <i class="fas fa-plus"></i>
      Adicionar Paciente
    </button>
  </div>

  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>CPF</th>
          <th>Data de Nascimento</th>
          <th>Telefone</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="pacientes-list">
        <!-- Lista de pacientes será inserida aqui via JavaScript -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de Adicionar/Editar Paciente -->
<div id="pacienteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
  <div style="background: white; max-width: 500px; margin: 2rem auto; padding: 2rem; border-radius: 12px; box-shadow: var(--shadow-md);">
    <h2 id="modalTitle">Adicionar Paciente</h2>
    <form id="pacienteForm" onsubmit="handleSubmit(event)">
      <div style="margin-bottom: 1rem;">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="cpf">CPF</label>
        <input type="text" id="cpf" name="cpf" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="data_nascimento">Data de Nascimento</label>
        <input type="date" id="data_nascimento" name="data_nascimento" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="telefone">Telefone</label>
        <input type="tel" id="telefone" name="telefone" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="senha">Senha</label>
        <input type="password" id="senha" name="senha" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
      </div>

      <div style="display: flex; justify-content: flex-end; gap: 1rem;">
        <button type="button" class="btn" onclick="closeModal()" style="background: var(--border-color);">Cancelar</button>
        <button type="submit" class="btn btn-primary">Salvar</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Função para carregar a lista de pacientes
  async function loadPacientes() {
    try {
      const response = await fetch('/pacientes');
      const pacientes = await response.json();
      
      const tbody = document.getElementById('pacientes-list');
      tbody.innerHTML = '';
      
      pacientes.forEach(paciente => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${paciente.usuario.nome}</td>
          <td>${paciente.usuario.email}</td>
          <td>${paciente.cpf}</td>
          <td>${new Date(paciente.data_nascimento).toLocaleDateString()}</td>
          <td>${paciente.telefone}</td>
          <td>
            <button class="btn" onclick="editPaciente(${paciente.id})" style="background: var(--primary-color-light); color: var(--primary-color); margin-right: 0.5rem;">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn" onclick="deletePaciente(${paciente.id})" style="background: var(--error-color); color: white;">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error('Erro ao carregar pacientes:', error);
    }
  }

  // Função para abrir o modal de adicionar paciente
  function openAddModal() {
    document.getElementById('modalTitle').textContent = 'Adicionar Paciente';
    document.getElementById('pacienteForm').reset();
    document.getElementById('pacienteModal').style.display = 'block';
  }

  // Função para fechar o modal
  function closeModal() {
    document.getElementById('pacienteModal').style.display = 'none';
  }

  // Função para lidar com o envio do formulário
  async function handleSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
      nome: formData.get('nome'),
      email: formData.get('email'),
      senha: formData.get('senha'),
      cpf: formData.get('cpf'),
      data_nascimento: formData.get('data_nascimento'),
      telefone: formData.get('telefone')
    };
    
    try {
      const response = await fetch('/pacientes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Erro ao adicionar paciente');
      }
      
      closeModal();
      loadPacientes();
    } catch (error) {
      console.error('Erro:', error);
      alert(error.message);
    }
  }

  // Função para editar um paciente
  async function editPaciente(id) {
    try {
      const response = await fetch(`/pacientes/${id}`);
      const paciente = await response.json();
      
      document.getElementById('modalTitle').textContent = 'Editar Paciente';
      document.getElementById('nome').value = paciente.usuario.nome;
      document.getElementById('email').value = paciente.usuario.email;
      document.getElementById('cpf').value = paciente.cpf;
      document.getElementById('data_nascimento').value = paciente.data_nascimento;
      document.getElementById('telefone').value = paciente.telefone;
      
      document.getElementById('pacienteModal').style.display = 'block';
    } catch (error) {
      console.error('Erro ao carregar paciente:', error);
      alert('Erro ao carregar dados do paciente');
    }
  }

  // Função para deletar um paciente
  async function deletePaciente(id) {
    if (!confirm('Tem certeza que deseja excluir este paciente?')) {
      return;
    }
    
    try {
      const response = await fetch(`/pacientes/${id}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        throw new Error('Erro ao excluir paciente');
      }
      
      loadPacientes();
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro ao excluir paciente');
    }
  }

  // Carrega a lista de pacientes quando a página carregar
  document.addEventListener('DOMContentLoaded', loadPacientes);
</script>
{% endblock %}